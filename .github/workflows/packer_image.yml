name: Packer Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-ami:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    env:
      PKR_VAR_DB_PASSWORD: SESdept@7829
      PKR_VAR_DB_USER: postgres
      PKR_VAR_DB_NAME: csye6225webapp
      PKR_VAR_ami_name: custom-ubuntu
      PKR_VAR_region: us-east-1
      PKR_VAR_instance_type: t2.small
      PKR_VAR_source_ami: ami-0866a3c8686eaeeba
      PKR_VAR_profile: csye6225-dev
      PKR_VAR_ssh_username: ubuntu

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Zip Artifact
        run: |
          zip -r webapp.zip ./

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install  
      
      - name: Configure Environment Variables
        run: |
          touch .env
          echo DB_HOST=localhost >> .env
          echo DB_PORT=5432 >> .env
          echo DB_DATABASE=csye6225webapp >> .env
          echo DB_DATABASE_TEST=csye6225webapp >> .env
          echo DB_USER=postgres >> .env
          echo DB_PASSWORD="SESdept@7829" >> .env

      - name: Set AMI Name with Date postfix
        run: |
          DATE=$(date +'%Y-%m-%d-%H-%M-%S')
          export PKR_VAR_ami_name="${{ secrets.AMI_NAME }}-${DATE}"

      - name: Set up AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: "AKIAQZFG5K6MBWM4E5PF"
          aws-secret-access-key: "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"
          aws-region: us-east-1

      - name: Set up Packer
        uses: hashicorp/setup-packer@main
        with:
          version: "latest"

      - name: Packer Init
        run: packer init aws-ubuntu.pkr.hcl

      - name: Validate Packer Template
        run: |
          packer validate aws-ubuntu.pkr.hcl

      - name: Build Packer Image
        run: |
          packer build aws-ubuntu.pkr.hcl
        id: packer-build
